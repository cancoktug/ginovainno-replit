# =============================================================================
# ITU Ginova - Apache Configuration
# Domain: ginova.itu.edu.tr
# =============================================================================

# Enable Rewrite Engine
RewriteEngine On

# Set base path
RewriteBase /

# Proxy settings - Forward API and dynamic requests to Node.js (PM2)
# Port 5000 is where the Node.js application runs

# Forward all /api/* requests to Node.js
RewriteCond %{REQUEST_URI} ^/api/ [NC]
RewriteRule ^(.*)$ http://127.0.0.1:5000/$1 [P,L]

# Forward /auth routes to Node.js (for SPA routing)
RewriteCond %{REQUEST_URI} ^/auth [NC]
RewriteRule ^(.*)$ http://127.0.0.1:5000/$1 [P,L]

# Forward /admin routes to Node.js (for SPA routing)
RewriteCond %{REQUEST_URI} ^/admin [NC]
RewriteRule ^(.*)$ http://127.0.0.1:5000/$1 [P,L]

# Forward /objects/* (uploaded images from object storage)
RewriteCond %{REQUEST_URI} ^/objects/ [NC]
RewriteRule ^(.*)$ http://127.0.0.1:5000/$1 [P,L]

# Forward Turkish URL routes to Node.js (SPA routing)
RewriteCond %{REQUEST_URI} ^/(programlar|mentorlar|yonetim|etkinlikler|hakkimizda|iletisim|blog|reset-password) [NC]
RewriteRule ^(.*)$ http://127.0.0.1:5000/$1 [P,L]

# Forward English URL routes to Node.js (backward compatibility)
RewriteCond %{REQUEST_URI} ^/(programs|mentors|management|events|about|contact) [NC]
RewriteRule ^(.*)$ http://127.0.0.1:5000/$1 [P,L]

# Forward startup routes
RewriteCond %{REQUEST_URI} ^/(startups|girisimler) [NC]
RewriteRule ^(.*)$ http://127.0.0.1:5000/$1 [P,L]

# Forward detail pages
RewriteCond %{REQUEST_URI} ^/(program|mentor|event|blog|startup)/ [NC]
RewriteRule ^(.*)$ http://127.0.0.1:5000/$1 [P,L]

# Forward booking routes
RewriteCond %{REQUEST_URI} ^/mentor-basvuru/ [NC]
RewriteRule ^(.*)$ http://127.0.0.1:5000/$1 [P,L]

# Serve static files from /uploads directory directly (if they exist)
RewriteCond %{REQUEST_URI} ^/uploads/
RewriteCond %{DOCUMENT_ROOT}%{REQUEST_URI} -f
RewriteRule ^uploads/(.*)$ uploads/$1 [L]

# If uploads file doesn't exist, forward to Node.js
RewriteCond %{REQUEST_URI} ^/uploads/
RewriteCond %{DOCUMENT_ROOT}%{REQUEST_URI} !-f
RewriteRule ^(.*)$ http://127.0.0.1:5000/$1 [P,L]

# Serve static assets directly from dist/public
RewriteCond %{REQUEST_URI} ^/assets/
RewriteCond %{DOCUMENT_ROOT}/dist/public%{REQUEST_URI} -f
RewriteRule ^assets/(.*)$ dist/public/assets/$1 [L]

# For root path and any other SPA routes, forward to Node.js
RewriteCond %{REQUEST_FILENAME} !-f
RewriteCond %{REQUEST_FILENAME} !-d
RewriteRule ^(.*)$ http://127.0.0.1:5000/$1 [P,L]

# Proxy preserve host header
RequestHeader set X-Forwarded-Proto "https"
RequestHeader set X-Forwarded-Host "%{HTTP_HOST}s"
RequestHeader set X-Real-IP "%{REMOTE_ADDR}s"

# Enable proxy response headers
ProxyPreserveHost On
ProxyRequests Off

# Handle WebSocket connections for development HMR (if needed)
RewriteCond %{HTTP:Upgrade} =websocket [NC]
RewriteRule ^(.*)$ ws://127.0.0.1:5000/$1 [P,L]

# Security Headers
Header set X-Content-Type-Options "nosniff"
Header set X-Frame-Options "SAMEORIGIN"
Header set X-XSS-Protection "1; mode=block"
Header set Referrer-Policy "strict-origin-when-cross-origin"

# Cache static assets
<IfModule mod_expires.c>
    ExpiresActive On
    ExpiresByType image/jpg "access plus 1 month"
    ExpiresByType image/jpeg "access plus 1 month"
    ExpiresByType image/png "access plus 1 month"
    ExpiresByType image/gif "access plus 1 month"
    ExpiresByType image/svg+xml "access plus 1 month"
    ExpiresByType image/webp "access plus 1 month"
    ExpiresByType text/css "access plus 1 week"
    ExpiresByType application/javascript "access plus 1 week"
    ExpiresByType application/x-javascript "access plus 1 week"
</IfModule>

# Compression
<IfModule mod_deflate.c>
    AddOutputFilterByType DEFLATE text/html text/plain text/xml text/css
    AddOutputFilterByType DEFLATE application/javascript application/x-javascript
    AddOutputFilterByType DEFLATE application/json
</IfModule>

# Prevent directory listing
Options -Indexes

# Error pages (optional)
ErrorDocument 500 "Server Error - Please try again later"
ErrorDocument 502 "Application is starting - Please wait a moment and refresh"
ErrorDocument 503 "Service temporarily unavailable"
